{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">
    <i class="bi bi-arrow-left-right text-primary"></i>
    {{ t.convert.title }}
</h2>

<!-- Smart Format Network -->
<div class="format-network-container mb-4">
    <div class="row">
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-upload"></i> {{ lang == 'tr' and 'Dosya Yükle' or 'Upload File' }}</h5>
                </div>
                <div class="card-body">
                    <div class="drop-zone drop-zone-large" data-input="smart-file">
                        <i class="bi bi-cloud-upload"></i>
                        <p>{{ t.common.drag_drop }}</p>
                        <input type="file" id="smart-file" accept=".pfx,.p12,.pem,.crt,.cer,.der,.p7b,.p7c,.jks,.keystore,.key" class="d-none">
                        <button type="button" class="btn btn-outline-primary btn-sm browse-btn">{{ t.common.browse }}</button>
                        <div class="mt-2">
                            <small class="text-muted">PFX, PEM, DER, P7B, JKS, CRT, CER, KEY</small>
                        </div>
                    </div>
                    <div id="uploaded-file-info" class="mt-3 d-none">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="bi bi-file-earmark-check me-2 fs-4"></i>
                            <div>
                                <strong id="uploaded-file-name"></strong>
                                <br>
                                <span class="badge bg-primary" id="uploaded-file-format"></span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="clearUploadedFile()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> {{ lang == 'tr' and 'Dönüşüm Seçenekleri' or 'Conversion Options' }}</h5>
                </div>
                <div class="card-body">
                    <div class="format-network" id="format-network">
                        <!-- Format nodes will be populated dynamically -->
                        <div class="format-nodes">
                            <div class="format-node" data-format="pem">
                                <div class="format-node-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                                <span>PEM</span>
                            </div>
                            <div class="format-node" data-format="pfx">
                                <div class="format-node-icon">
                                    <i class="bi bi-file-earmark-lock"></i>
                                </div>
                                <span>PFX</span>
                            </div>
                            <div class="format-node" data-format="der">
                                <div class="format-node-icon">
                                    <i class="bi bi-file-earmark-binary"></i>
                                </div>
                                <span>DER</span>
                            </div>
                            <div class="format-node" data-format="p7b">
                                <div class="format-node-icon">
                                    <i class="bi bi-file-earmark-zip"></i>
                                </div>
                                <span>P7B</span>
                            </div>
                            <div class="format-node" data-format="jks">
                                <div class="format-node-icon">
                                    <i class="bi bi-filetype-java"></i>
                                </div>
                                <span>JKS</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="format-actions mt-3">
                            <div class="action-node" data-action="extract_key">
                                <i class="bi bi-key"></i>
                                <span>{{ t.convert.types.extract_key }}</span>
                            </div>
                            <div class="action-node" data-action="extract_cert">
                                <i class="bi bi-file-earmark-medical"></i>
                                <span>{{ t.convert.types.extract_cert }}</span>
                            </div>
                        </div>
                    </div>

                    <div id="no-file-hint" class="text-center text-muted py-4">
                        <i class="bi bi-info-circle fs-4"></i>
                        <p class="mb-0">{{ lang == 'tr' and 'Dönüşüm seçeneklerini görmek için dosya yükleyin' or 'Upload a file to see conversion options' }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Conversion Form (shown when target is selected) -->
<div id="conversion-panel" class="card d-none">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0" id="conversion-title">
            <i class="bi bi-arrow-right-circle"></i>
            <span id="conversion-from"></span> → <span id="conversion-to"></span>
        </h5>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideConversionPanel()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="card-body">
        <form id="smart-convert-form">
            <!-- Password field for PFX/JKS source -->
            <div id="source-password-group" class="mb-3 d-none">
                <label class="form-label" id="source-password-label">{{ t.convert.password }}</label>
                <input type="password" class="form-control" id="source-password">
            </div>

            <!-- Target password for PFX/JKS output -->
            <div id="target-password-group" class="mb-3 d-none">
                <label class="form-label" id="target-password-label">{{ t.convert.new_password }}</label>
                <input type="password" class="form-control" id="target-password">
            </div>

            <!-- Alias for JKS -->
            <div id="alias-group" class="mb-3 d-none">
                <label class="form-label">{{ t.convert.alias }}</label>
                <input type="text" class="form-control" id="conversion-alias" value="certificate">
            </div>

            <!-- Friendly name for PFX -->
            <div id="friendly-name-group" class="mb-3 d-none">
                <label class="form-label">{{ t.convert.friendly_name }}</label>
                <input type="text" class="form-control" id="conversion-friendly-name" value="certificate">
            </div>

            <!-- Key format for PEM output -->
            <div id="key-format-group" class="mb-3 d-none">
                <label class="form-label">{{ t.convert.key_format }}</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="key-format" id="key-format-pkcs8" value="pkcs8" checked>
                    <label class="form-check-label" for="key-format-pkcs8">
                        PKCS#8 <small class="text-muted">({{ t.convert.recommended }})</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="key-format" id="key-format-traditional" value="traditional">
                    <label class="form-check-label" for="key-format-traditional">
                        Traditional OpenSSL <small class="text-muted">({{ t.convert.legacy_compat }})</small>
                    </label>
                </div>
            </div>

            <!-- Split export for PFX to PEM -->
            <div id="split-export-group" class="mb-3 d-none">
                <label class="form-label">{{ t.convert.export_mode }}</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="split-export">
                    <label class="form-check-label" for="split-export">
                        {{ t.convert.split_files }} <small class="text-muted">(ZIP)</small>
                    </label>
                </div>
            </div>

            <!-- Additional file for PEM to PFX/JKS (key file) -->
            <div id="key-file-group" class="mb-3 d-none">
                <label class="form-label">{{ t.convert.private_key }} (PEM)</label>
                <div class="drop-zone" data-input="key-file">
                    <i class="bi bi-cloud-upload"></i>
                    <p>{{ t.common.drag_drop }}</p>
                    <input type="file" id="key-file" accept=".pem,.key" class="d-none">
                    <button type="button" class="btn btn-outline-primary btn-sm browse-btn">{{ t.common.browse }}</button>
                </div>
                <small class="text-muted file-name"></small>
            </div>

            <!-- Chain file (optional) -->
            <div id="chain-file-group" class="mb-3 d-none">
                <label class="form-label">{{ t.convert.chain }}</label>
                <div class="drop-zone" data-input="chain-file">
                    <i class="bi bi-cloud-upload"></i>
                    <p>{{ t.common.drag_drop }}</p>
                    <input type="file" id="chain-file" accept=".pem,.crt,.cer" class="d-none">
                    <button type="button" class="btn btn-outline-primary btn-sm browse-btn">{{ t.common.browse }}</button>
                </div>
                <small class="text-muted file-name"></small>
            </div>

            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="bi bi-arrow-repeat"></i> {{ t.convert.convert_btn }}
            </button>
        </form>
    </div>
</div>

<!-- Result -->
<div id="convert-result" class="card mt-4 d-none">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-check-circle text-success"></i> {{ t.common.success }}</h5>
    </div>
    <div class="card-body">
        <div id="result-content"></div>
    </div>
</div>

<!-- Conversion Matrix Reference -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-table"></i> {{ t.docs.matrix.title }}</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-bordered conversion-matrix-table">
                <thead>
                    <tr>
                        <th>{{ t.docs.matrix.from }} \ {{ t.docs.matrix.to }}</th>
                        <th>PEM</th>
                        <th>PFX</th>
                        <th>DER</th>
                        <th>P7B</th>
                        <th>JKS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>PFX</th>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-na">-</td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                    </tr>
                    <tr>
                        <th>PEM</th>
                        <td class="matrix-na">-</td>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                    </tr>
                    <tr>
                        <th>DER</th>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-na">-</td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                    </tr>
                    <tr>
                        <th>P7B</th>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-na">-</td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                    </tr>
                    <tr>
                        <th>JKS</th>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-yes"><i class="bi bi-check-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-no"><i class="bi bi-x-lg"></i></td>
                        <td class="matrix-na">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="bi bi-check-lg text-success"></i> {{ t.docs.matrix.supported }} |
                <i class="bi bi-x-lg text-danger"></i> {{ lang == 'tr' and 'Desteklenmiyor' or 'Not supported' }} |
                <i class="bi bi-key text-info"></i> {{ lang == 'tr' and 'PFX\'ten Key/Cert çıkarma desteklenir' or 'Extract Key/Cert from PFX supported' }}
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    initSmartConvertPage();
</script>
{% endblock %}
