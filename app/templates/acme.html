{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-shield-check"></i> {{ t.acme.title }}</h2>

        <!-- Wizard Steps -->
        <div class="wizard-steps mb-4">
            <div class="d-flex justify-content-between position-relative">
                <div class="wizard-line"></div>
                <div class="wizard-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">{{ t.acme.step1_title }}</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">{{ t.acme.step2_title }}</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">{{ t.acme.step3_title }}</div>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">{{ t.acme.step4_title }}</div>
                </div>
            </div>
        </div>

        <!-- Step 1: Account Setup -->
        <div class="wizard-content" id="step-1">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-person-plus"></i> {{ t.acme.step1_title }}
                </div>
                <div class="card-body">
                    <!-- Existing Accounts -->
                    <div id="existing-accounts" class="mb-4 d-none">
                        <h6>{{ t.acme.existing_accounts }}</h6>
                        <div class="list-group mb-3" id="accounts-list"></div>
                    </div>

                    <!-- New Account Form -->
                    <form id="register-form">
                        <div class="mb-3">
                            <label class="form-label">{{ t.acme.email }}</label>
                            <input type="email" class="form-control" id="acme-email" required placeholder="admin@example.com">
                            <div class="form-text">{{ t.acme.email_hint }}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ t.acme.environment }}</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="environment" id="env-staging" value="staging" checked>
                                <label class="btn btn-outline-warning" for="env-staging">
                                    <i class="bi bi-bug"></i> {{ t.acme.use_staging }}
                                </label>
                                <input type="radio" class="btn-check" name="environment" id="env-production" value="production">
                                <label class="btn btn-outline-success" for="env-production">
                                    <i class="bi bi-check-circle"></i> {{ t.acme.use_production }}
                                </label>
                            </div>
                            <div class="form-text">{{ t.acme.staging_warning }}</div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i> {{ t.acme.register_account }}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Step 2: Domain Configuration -->
        <div class="wizard-content d-none" id="step-2">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-globe"></i> {{ t.acme.step2_title }}
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <span id="selected-account-info"></span>
                    </div>

                    <form id="order-form">
                        <div class="mb-3">
                            <label class="form-label">{{ t.acme.domains }}</label>
                            <textarea class="form-control" id="acme-domains" rows="3" required placeholder="example.com&#10;www.example.com"></textarea>
                            <div class="form-text">{{ t.acme.domains_hint }}</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
                                <i class="bi bi-arrow-left"></i> {{ t.acme.back }}
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> {{ t.acme.create_order }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Step 3: Domain Validation -->
        <div class="wizard-content d-none" id="step-3">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-check2-square"></i> {{ t.acme.step3_title }}
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        {{ t.acme.challenge_instructions }}
                    </div>

                    <div id="challenges-container"></div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                            <i class="bi bi-arrow-left"></i> {{ t.acme.back }}
                        </button>
                        <button type="button" class="btn btn-primary" id="verify-btn" onclick="verifyAllChallenges()">
                            <i class="bi bi-check-circle"></i> {{ t.acme.verify_domains }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Certificate Download -->
        <div class="wizard-content d-none" id="step-4">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-download"></i> {{ t.acme.step4_title }}
                </div>
                <div class="card-body">
                    <div id="certificate-result"></div>

                    <div class="d-flex gap-2 mt-4">
                        <button type="button" class="btn btn-outline-primary" onclick="startNewOrder()">
                            <i class="bi bi-plus-circle"></i> {{ t.acme.new_order }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.wizard-steps {
    position: relative;
    padding: 0 20px;
}

.wizard-line {
    position: absolute;
    top: 20px;
    left: 60px;
    right: 60px;
    height: 2px;
    background: var(--bs-border-color);
    z-index: 0;
}

.wizard-step {
    position: relative;
    z-index: 1;
    text-align: center;
    flex: 1;
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bs-body-bg);
    border: 2px solid var(--bs-border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-weight: bold;
    color: var(--bs-secondary);
}

.wizard-step.active .step-circle {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.wizard-step.completed .step-circle {
    background: var(--bs-success);
    border-color: var(--bs-success);
    color: white;
}

.step-label {
    font-size: 0.85rem;
    color: var(--bs-secondary);
}

.wizard-step.active .step-label {
    color: var(--bs-primary);
    font-weight: 500;
}

.challenge-card {
    border-left: 4px solid var(--bs-warning);
}

.challenge-card.verified {
    border-left-color: var(--bs-success);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
let selectedAccountId = null;
let currentOrderId = null;

document.addEventListener('DOMContentLoaded', () => {
    initACMEPage();
});

async function initACMEPage() {
    // Load existing accounts
    await loadAccounts();

    // Register form
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await registerAccount();
    });

    // Order form
    document.getElementById('order-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createOrder();
    });
}

async function loadAccounts() {
    try {
        const response = await fetch('/api/acme/accounts');
        const data = await response.json();

        if (data.accounts && data.accounts.length > 0) {
            const container = document.getElementById('existing-accounts');
            const list = document.getElementById('accounts-list');

            container.classList.remove('d-none');
            list.innerHTML = data.accounts.map(acc => `
                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="selectAccount('${acc.account_id}', '${escapeHtml(acc.email)}', '${acc.environment}')">
                    <div>
                        <strong>${escapeHtml(acc.email)}</strong>
                        <span class="badge ${acc.environment === 'production' ? 'bg-success' : 'bg-warning'} ms-2">
                            ${acc.environment}
                        </span>
                    </div>
                    <i class="bi bi-chevron-right"></i>
                </button>
            `).join('');
        }
    } catch (err) {
        console.error('Failed to load accounts:', err);
    }
}

async function registerAccount() {
    const email = document.getElementById('acme-email').value;
    const environment = document.querySelector('input[name="environment"]:checked').value;

    const formData = new FormData();
    formData.append('email', email);
    formData.append('environment', environment);

    try {
        const response = await fetch('/api/acme/register', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast(data.message || window.T.common.success);
            selectedAccountId = data.account_id;
            document.getElementById('selected-account-info').textContent =
                `${email} (${environment})`;
            goToStep(2);
            await loadAccounts();
        } else {
            showToast(data.detail || 'Registration failed', 'error');
        }
    } catch (err) {
        showToast(err.message, 'error');
    }
}

function selectAccount(accountId, email, environment) {
    selectedAccountId = accountId;
    document.getElementById('selected-account-info').textContent =
        `${email} (${environment})`;
    goToStep(2);
}

async function createOrder() {
    const domainsText = document.getElementById('acme-domains').value;
    const domains = domainsText.split('\n')
        .map(d => d.trim())
        .filter(d => d.length > 0)
        .join(',');

    if (!domains) {
        showToast(window.T.acme.no_domains || 'Please enter at least one domain', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('account_id', selectedAccountId);
    formData.append('domains', domains);

    try {
        const response = await fetch('/api/acme/order/create', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            currentOrderId = data.order_id;
            showToast(window.T.common.success);
            await loadChallenges();
            goToStep(3);
        } else {
            showToast(data.detail || 'Order creation failed', 'error');
        }
    } catch (err) {
        showToast(err.message, 'error');
    }
}

async function loadChallenges() {
    try {
        const response = await fetch(`/api/acme/order/${currentOrderId}/challenge?account_id=${selectedAccountId}`);
        const data = await response.json();

        if (data.success && data.challenges) {
            const container = document.getElementById('challenges-container');
            container.innerHTML = '';

            for (const [domain, challenge] of Object.entries(data.challenges)) {
                const card = document.createElement('div');
                card.className = 'card mb-3 challenge-card';
                card.id = `challenge-${domain.replace(/\./g, '-')}`;
                card.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-globe"></i> ${escapeHtml(domain)}</span>
                        <span class="badge bg-warning" id="status-${domain.replace(/\./g, '-')}">
                            ${challenge.status || 'pending'}
                        </span>
                    </div>
                    <div class="card-body">
                        <p><strong>${window.T.acme?.create_file || 'Create this file on your server'}:</strong></p>
                        <div class="bg-light p-3 rounded mb-3">
                            <code>${escapeHtml(challenge.validation_url)}</code>
                        </div>
                        <p><strong>${window.T.acme?.file_content || 'File content'}:</strong></p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control font-monospace" value="${escapeHtml(challenge.key_authorization)}" readonly>
                            <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('${escapeJs(challenge.key_authorization)}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="verifySingleChallenge('${escapeJs(domain)}')">
                            <i class="bi bi-check"></i> ${window.T.acme?.verify_this || 'Verify'}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            }
        }
    } catch (err) {
        showToast(err.message, 'error');
    }
}

async function verifySingleChallenge(domain) {
    const formData = new FormData();
    formData.append('account_id', selectedAccountId);
    formData.append('domain', domain);

    try {
        const response = await fetch(`/api/acme/order/${currentOrderId}/verify`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success && data.results[domain]) {
            const result = data.results[domain];
            const statusEl = document.getElementById(`status-${domain.replace(/\./g, '-')}`);
            const cardEl = document.getElementById(`challenge-${domain.replace(/\./g, '-')}`);

            if (result.status === 'valid' || result.status === 'already_valid') {
                statusEl.className = 'badge bg-success';
                statusEl.textContent = 'valid';
                cardEl.classList.add('verified');
            } else if (result.status === 'pending') {
                statusEl.className = 'badge bg-warning';
                statusEl.textContent = 'pending';
            } else {
                statusEl.className = 'badge bg-danger';
                statusEl.textContent = result.status || 'error';
            }
        }
    } catch (err) {
        showToast(err.message, 'error');
    }
}

async function verifyAllChallenges() {
    const formData = new FormData();
    formData.append('account_id', selectedAccountId);

    try {
        const response = await fetch(`/api/acme/order/${currentOrderId}/verify`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            let allValid = true;
            for (const [domain, result] of Object.entries(data.results)) {
                const statusEl = document.getElementById(`status-${domain.replace(/\./g, '-')}`);
                const cardEl = document.getElementById(`challenge-${domain.replace(/\./g, '-')}`);

                if (result.status === 'valid' || result.status === 'already_valid') {
                    if (statusEl) {
                        statusEl.className = 'badge bg-success';
                        statusEl.textContent = 'valid';
                    }
                    if (cardEl) cardEl.classList.add('verified');
                } else {
                    allValid = false;
                    if (statusEl) {
                        statusEl.className = 'badge bg-warning';
                        statusEl.textContent = result.status || 'pending';
                    }
                }
            }

            if (allValid) {
                showToast(window.T.acme?.all_verified || 'All domains verified');
                await finalizeOrder();
            } else {
                showToast(window.T.acme?.some_pending || 'Some domains still pending', 'error');
            }
        }
    } catch (err) {
        showToast(err.message, 'error');
    }
}

async function finalizeOrder() {
    const formData = new FormData();
    formData.append('account_id', selectedAccountId);

    try {
        const response = await fetch(`/api/acme/order/${currentOrderId}/finalize`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success && data.certificate_pem) {
            displayCertificate(data);
            goToStep(4);
        } else {
            showToast(data.message || 'Finalization pending', 'error');
        }
    } catch (err) {
        showToast(err.message, 'error');
    }
}

function displayCertificate(data) {
    const container = document.getElementById('certificate-result');

    container.innerHTML = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill"></i>
            ${window.T.acme?.certificate_issued || 'Certificate issued successfully!'}
        </div>

        <div class="mb-4">
            <h6><i class="bi bi-file-earmark-lock2"></i> ${window.T.convert?.certificate || 'Certificate'}</h6>
            <pre class="pem-output">${escapeHtml(data.certificate_pem)}</pre>
            <div class="action-buttons">
                <button class="btn btn-outline-primary btn-sm" onclick="copyToClipboard(\`${escapeJs(data.certificate_pem)}\`)">
                    <i class="bi bi-clipboard"></i> ${window.T.convert?.copy || 'Copy'}
                </button>
                <button class="btn btn-primary btn-sm" onclick="downloadFile(\`${escapeJs(data.certificate_pem)}\`, 'certificate.pem')">
                    <i class="bi bi-download"></i> ${window.T.convert?.download || 'Download'}
                </button>
            </div>
        </div>

        ${data.private_key_pem ? `
        <div class="mb-4">
            <h6><i class="bi bi-key"></i> ${window.T.convert?.private_key || 'Private Key'}</h6>
            <pre class="pem-output">${escapeHtml(data.private_key_pem)}</pre>
            <div class="action-buttons">
                <button class="btn btn-outline-primary btn-sm" onclick="copyToClipboard(\`${escapeJs(data.private_key_pem)}\`)">
                    <i class="bi bi-clipboard"></i> ${window.T.convert?.copy || 'Copy'}
                </button>
                <button class="btn btn-primary btn-sm" onclick="downloadFile(\`${escapeJs(data.private_key_pem)}\`, 'private_key.pem')">
                    <i class="bi bi-download"></i> ${window.T.convert?.download || 'Download'}
                </button>
            </div>
        </div>
        ` : ''}
    `;
}

function goToStep(step) {
    // Hide all steps
    document.querySelectorAll('.wizard-content').forEach(el => el.classList.add('d-none'));

    // Show target step
    document.getElementById(`step-${step}`).classList.remove('d-none');

    // Update step indicators
    document.querySelectorAll('.wizard-step').forEach(el => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('active', 'completed');
        if (stepNum === step) {
            el.classList.add('active');
        } else if (stepNum < step) {
            el.classList.add('completed');
        }
    });

    currentStep = step;
}

function startNewOrder() {
    currentOrderId = null;
    goToStep(2);
}
</script>
{% endblock %}
